<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NED Secure AI</title>
    <script src="./config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-dark">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="hljs-light" disabled>
    <style>
        /* Theme Variables */
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --bg-quaternary: #4b5563;
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --text-tertiary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
        }
        
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --bg-quaternary: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-tertiary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #d1d5db;
            --accent-blue: #2563eb;
            --accent-green: #059669;
            --accent-purple: #7c3aed;
            --accent-yellow: #d97706;
            --accent-red: #dc2626;
        }
        
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Theme toggle button */
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .theme-toggle:hover {
            background: var(--bg-quaternary);
        }
        
        /* Markdown Styling using CSS Variables */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: var(--text-primary);
            font-weight: bold;
            margin: 1rem 0 0.5rem 0;
        }
        .markdown-content h1 { font-size: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        .markdown-content h2 { font-size: 1.3rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        
        .markdown-content p {
            margin: 0.75rem 0;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        .markdown-content code {
            background-color: var(--bg-tertiary);
            color: var(--accent-yellow);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .markdown-content pre {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
            position: relative;
        }
        
        .markdown-content pre code {
            background: none;
            color: var(--text-secondary);
            padding: 0;
            font-size: 0.875rem;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid var(--accent-blue);
            margin: 1rem 0;
            padding-left: 1rem;
            color: var(--text-tertiary);
            font-style: italic;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 0.75rem 0;
            padding-left: 1.5rem;
            color: var(--text-secondary);
        }
        
        .markdown-content li {
            margin: 0.25rem 0;
        }
        
        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }
        
        .markdown-content th, .markdown-content td {
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            text-align: left;
            color: var(--text-secondary);
        }
        
        .markdown-content th {
            background-color: var(--bg-tertiary);
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .markdown-content a {
            color: var(--accent-blue);
            text-decoration: underline;
        }
        
        .markdown-content a:hover {
            opacity: 0.8;
        }
        
        .markdown-content strong {
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .markdown-content em {
            font-style: italic;
            color: var(--text-secondary);
        }
        
        /* Copy button for code blocks */
        .code-block-wrapper {
            position: relative;
        }
        
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--bg-quaternary);
            color: var(--text-secondary);
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .copy-button:hover {
            opacity: 1;
        }
    </style>
</head>
<body style="background-color: var(--bg-primary); color: var(--text-primary);" class="h-screen overflow-hidden flex flex-col">
    <!-- Header -->
    <div style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" class="px-6 py-4 flex-shrink-0">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold" style="color: var(--text-primary);">NED Secure AI</h1>
                <p class="text-sm" style="color: var(--text-muted);">AI-Powered Chat, File Processing & Web Search</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- Model Selector -->
                <div class="flex items-center gap-2">
                    <span class="text-sm" style="color: var(--text-muted);">Model:</span>
                    <select 
                        id="modelSelector" 
                        class="px-3 py-1 rounded border focus:outline-none focus:ring-2 transition-colors text-sm"
                        style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);"
                        onchange="changeModel()"
                    >
                        <option value="qwen3">Qwen3 (Loading...)</option>
                    </select>
                </div>
                
                <button onclick="toggleTheme()" class="theme-toggle" title="Toggle Theme">
                    <span id="themeIcon">üåô</span>
                </button>
                
                <div id="connectionStatus" class="text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <span>Checking connection...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Interface -->
    <div class="flex flex-1 min-h-0">
        <!-- Chat Section -->
        <div class="flex-1 flex flex-col">
            <div class="flex-1 flex flex-col m-4 rounded-lg min-h-0" style="background-color: var(--bg-secondary);">
                <div class="p-4 flex-shrink-0 flex items-center justify-between" style="border-bottom: 1px solid var(--border-color);">
                    <h2 class="text-xl font-semibold" style="color: var(--text-primary);">Chat</h2>
                    <button 
                        onclick="clearChat()" 
                        class="px-3 py-1 rounded text-xs transition-colors"
                        style="background-color: var(--bg-quaternary); color: var(--text-secondary); border: 1px solid var(--border-color);"
                        onmouseover="this.style.backgroundColor='var(--accent-red)'; this.style.color='white'"
                        onmouseout="this.style.backgroundColor='var(--bg-quaternary)'; this.style.color='var(--text-secondary)'"
                        title="Clear all chat messages"
                    >
                        üóëÔ∏è Clear Chat
                    </button>
                </div>
                
                <!-- Chat Messages -->
                <div id="chatMessages" class="flex-1 overflow-y-auto p-4 min-h-0" style="background-color: var(--bg-primary);">
                    <div class="text-center" style="color: var(--text-muted);">Start a conversation...</div>
                </div>

                <!-- Chat Input -->
                <div class="p-4 flex-shrink-0" style="background-color: var(--bg-secondary); border-top: 1px solid var(--border-color);">
                    <div class="flex gap-3">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Type your message..." 
                            class="flex-1 px-4 py-3 rounded-lg focus:outline-none focus:ring-2 transition-colors"
                            style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); focus:ring-color: var(--accent-blue);"
                            onkeypress="handleKeyPress(event)"
                        >
                        <button 
                            onclick="sendMessage()" 
                            class="px-8 py-3 rounded-lg focus:outline-none focus:ring-2 transition-colors"
                            style="background-color: var(--accent-blue); color: white; focus:ring-color: var(--accent-blue);"
                            onmouseover="this.style.opacity='0.9'"
                            onmouseout="this.style.opacity='1'"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Section -->
        <div class="w-80 flex flex-col" style="background-color: var(--bg-secondary); border-left: 1px solid var(--border-color);">
            <div class="p-4" style="border-bottom: 1px solid var(--border-color);">
                <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Tools</h2>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- File Upload -->
                <div class="rounded-lg p-6" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">File Upload</h3>
                    <div class="space-y-4">
                        <input 
                            type="file" 
                            id="fileInput" 
                            accept=".pdf,.docx,.txt,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 rounded-lg focus:outline-none focus:ring-2 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold transition-colors"
                            style="background-color: var(--bg-quaternary); border: 1px solid var(--border-color); color: var(--text-primary); file:background-color: var(--accent-blue); file:color: white;"
                        >
                        <button 
                            onclick="uploadFile()" 
                            class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 transition-colors"
                            style="background-color: var(--accent-green); color: white;"
                            onmouseover="this.style.opacity='0.9'"
                            onmouseout="this.style.opacity='1'"
                        >
                            Upload & Process
                        </button>
                        <div id="uploadStatus" class="text-sm" style="color: var(--text-tertiary);"></div>
                    </div>
                </div>

                <!-- Web Search -->
                <div class="rounded-lg p-6" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Web Search</h3>
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="Search query..." 
                            class="w-full px-3 py-3 rounded-lg focus:outline-none focus:ring-2 transition-colors"
                            style="background-color: var(--bg-quaternary); border: 1px solid var(--border-color); color: var(--text-primary);"
                            onkeypress="handleSearchKeyPress(event)"
                        >
                        <button 
                            onclick="performSearch()" 
                            class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 transition-colors"
                            style="background-color: var(--accent-purple); color: white;"
                            onmouseover="this.style.opacity='0.9'"
                            onmouseout="this.style.opacity='1'"
                        >
                            Search Web
                        </button>
                        <div id="searchStatus" class="text-sm" style="color: var(--text-tertiary);"></div>
                    </div>
                </div>

                <!-- Model Info -->
                <div class="rounded-lg p-6" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Model Info</h3>
                    <div class="space-y-2 text-sm" style="color: var(--text-tertiary);">
                        <div class="flex justify-between">
                            <span>Model:</span>
                            <span style="color: var(--accent-blue);">Qwen3</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Context:</span>
                            <span style="color: var(--accent-blue);">8192 tokens</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Max Response:</span>
                            <span style="color: var(--accent-blue);">4000 tokens</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Server:</span>
                            <span style="color: var(--accent-blue);">GPUStack</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.CONFIG ? window.CONFIG.BACKEND_URL : 'http://localhost:8001';
        let conversationContext = [];
        let currentModel = 'qwen3';
        let availableModels = [];

        // Check backend connection and load models on page load
        window.onload = function() {
            checkConnection();
            loadAvailableModels();
        };

        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                if (data.message) {
                    document.getElementById('connectionStatus').innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                            <span class="text-green-400">Backend Connected</span>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                        <span class="text-red-400">Backend Disconnected</span>
                    </div>
                `;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        // Calculate dynamic max_tokens based on model's context window
        function calculateMaxTokens() {
            const currentModelData = availableModels.find(m => m.name === currentModel);
            if (!currentModelData || !currentModelData.meta?.n_ctx) {
                return 4000; // fallback
            }
            
            const contextWindow = currentModelData.meta.n_ctx;
            // Use 60% of context window for response, leaving 40% for conversation history
            const maxTokens = Math.floor(contextWindow * 0.6);
            
            // Set reasonable bounds
            return Math.min(Math.max(maxTokens, 1000), 50000); // min 1000, max 50000
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessageToChat('user', message);
            input.value = '';

            // Create streaming message placeholder
            const streamingMessageId = addStreamingMessage('assistant');
            let fullResponse = '';

            // Calculate dynamic max_tokens
            const maxTokens = calculateMaxTokens();

            try {
                // Try streaming first
                const response = await fetch(`${API_BASE}/api/inference/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            ...conversationContext,
                            { role: "user", content: message }
                        ],
                        temperature: 0.7,
                        max_tokens: maxTokens
                    })
                });

                if (response.ok && response.body) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    try {
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6).trim();
                                    
                                    if (data === '[DONE]') {
                                        break;
                                    }
                                    
                                    if (data) {
                                        try {
                                            const parsed = JSON.parse(data);
                                            const content = parsed.choices?.[0]?.delta?.content || '';
                                            
                                            if (content) {
                                                fullResponse += content;
                                                updateStreamingMessage(streamingMessageId, fullResponse);
                                            }
                                        } catch (e) {
                                            // Ignore JSON parse errors
                                        }
                                    }
                                }
                            }
                        }
                        
                        // Finalize the streaming message (remove cursor)
                        finalizeStreamingMessage(streamingMessageId, fullResponse);
                        
                        // Update conversation context with complete response
                        conversationContext.push(
                            { role: "user", content: message },
                            { role: "assistant", content: fullResponse }
                        );
                        
                        // Keep only last 10 messages for context
                        if (conversationContext.length > 20) {
                            conversationContext = conversationContext.slice(-20);
                        }
                        
                    } catch (streamError) {
                        console.error('Streaming error:', streamError);
                        // Fall back to non-streaming
                        await sendNonStreamingMessage(message, streamingMessageId);
                    }
                } else {
                    // Fall back to non-streaming
                    await sendNonStreamingMessage(message, streamingMessageId);
                }
            } catch (error) {
                removeMessage(streamingMessageId);
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }
        
        async function sendNonStreamingMessage(message, streamingMessageId) {
            try {
                removeMessage(streamingMessageId);
                
                // Calculate dynamic max_tokens
                const maxTokens = calculateMaxTokens();
                
                const response = await fetch(`${API_BASE}/api/inference/infer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            ...conversationContext,
                            { role: "user", content: message }
                        ],
                        temperature: 0.7,
                        max_tokens: maxTokens
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const aiResponse = data.choices?.[0]?.message?.content || 'No response received';
                    
                    addMessageToChat('assistant', aiResponse);
                    
                    conversationContext.push(
                        { role: "user", content: message },
                        { role: "assistant", content: aiResponse }
                    );
                    
                    if (conversationContext.length > 20) {
                        conversationContext = conversationContext.slice(-20);
                    }
                } else {
                    addMessageToChat('system', 'Error: Could not connect to GPUStack');
                }
            } catch (error) {
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                updateStatus('uploadStatus', 'Please select a file', 'text-red-400');
                return;
            }

            updateStatus('uploadStatus', 'Uploading...', 'text-blue-400');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/api/files/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    updateStatus('uploadStatus', 'File processed successfully!', 'text-green-400');
                    
                    // Add file content to chat
                    addMessageToChat('system', `File "${file.name}" processed. Content extracted.`);
                    
                    // Add file content to conversation context for AI
                    if (data.content) {
                        // Limit file content to prevent context overflow
                        const truncatedContent = data.content.length > 1500 ? 
                            data.content.substring(0, 1500) + '...[content truncated]' : 
                            data.content;
                        
                        conversationContext.push({
                            role: "system",
                            content: `File content from ${file.name}: ${truncatedContent}`
                        });
                        
                        // Ensure we don't exceed context limits
                        if (conversationContext.length > 10) {
                            conversationContext = conversationContext.slice(-10);
                        }
                    }
                } else {
                    updateStatus('uploadStatus', 'Upload failed', 'text-red-400');
                }
            } catch (error) {
                updateStatus('uploadStatus', `Error: ${error.message}`, 'text-red-400');
            }
        }

        async function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query) {
                updateStatus('searchStatus', 'Please enter a search query', 'text-red-400');
                return;
            }

            updateStatus('searchStatus', 'Searching...', 'text-blue-400');

            try {
                const response = await fetch(`${API_BASE}/api/tools/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ q: query })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Search response:', data); // Debug
                    updateStatus('searchStatus', 'Search completed!', 'text-green-400');
                    
                    // Extract search result data
                    const searchResult = data.result;
                    const results = searchResult.results || [];
                    const llmSummary = searchResult.llm_summary || null;
                    const processingStatus = searchResult.processing_status || null;
                    
                    console.log('Results:', results.length, 'LLM:', !!llmSummary, 'Status:', processingStatus); // Debug
                    
                    // Display enhanced search results with LLM processing
                    displaySearchResults(results, llmSummary, processingStatus);
                    
                    // Create enhanced context summary for AI
                    let contextSummary;
                    if (llmSummary && processingStatus === 'success') {
                        // Use the LLM-processed summary as primary context
                        contextSummary = `Web search for "${query}": ${llmSummary}`;
                    } else {
                        // Fall back to basic summary
                        contextSummary = `Web search results for "${query}": ` + createSearchContextSummary(results);
                    }
                    
                    conversationContext.push({
                        role: "system",
                        content: contextSummary
                    });
                    
                    searchInput.value = '';
                } else {
                    updateStatus('searchStatus', 'Search failed', 'text-red-400');
                }
            } catch (error) {
                updateStatus('searchStatus', `Error: ${error.message}`, 'text-red-400');
            }
        }

        function addMessageToChat(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Clear initial message
            if (chatMessages.children.length === 1 && chatMessages.children[0].querySelector('[style*="color: var(--text-muted)"]')) {
                chatMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message mb-4 ${role === 'user' ? 'text-right' : 'text-left'}`;

            // Render content based on role
            let renderedContent;
            if (role === 'assistant') {
                // Render markdown for AI responses
                renderedContent = renderMarkdown(content);
            } else {
                // Plain text for user and system messages
                renderedContent = `<div class="whitespace-pre-wrap text-sm leading-relaxed">${escapeHtml(content)}</div>`;
            }

            // Use CSS variables for styling
            let messageStyle, textColor;
            if (role === 'user') {
                messageStyle = 'background-color: var(--accent-blue); color: white;';
                textColor = 'color: white;';
            } else if (role === 'assistant') {
                messageStyle = 'background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color);';
                textColor = 'color: var(--text-primary);';
            } else {
                messageStyle = 'background-color: var(--accent-yellow); color: var(--bg-primary);';
                textColor = 'color: var(--bg-primary);';
            }

            messageDiv.innerHTML = `
                <div class="inline-block max-w-full lg:max-w-4xl px-4 py-3 rounded-lg" style="${messageStyle}">
                    <div class="text-xs opacity-75 mb-2" style="${textColor}">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
                    ${renderedContent}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            
            // Apply syntax highlighting to code blocks for assistant messages
            if (role === 'assistant') {
                messageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addStreamingMessage(role) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Clear initial message
            if (chatMessages.children.length === 1 && chatMessages.children[0].querySelector('[style*="color: var(--text-muted)"]')) {
                chatMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            const messageId = 'streaming-' + Date.now();
            messageDiv.id = messageId;
            messageDiv.className = `chat-message mb-4 ${role === 'user' ? 'text-right' : 'text-left'}`;

            // Use CSS variables for styling
            let messageStyle, textColor;
            if (role === 'user') {
                messageStyle = 'background-color: var(--accent-blue); color: white;';
                textColor = 'color: white;';
            } else if (role === 'assistant') {
                messageStyle = 'background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color);';
                textColor = 'color: var(--text-primary);';
            } else {
                messageStyle = 'background-color: var(--accent-yellow); color: var(--bg-primary);';
                textColor = 'color: var(--bg-primary);';
            }

            messageDiv.innerHTML = `
                <div class="inline-block max-w-full lg:max-w-4xl px-4 py-3 rounded-lg" style="${messageStyle}">
                    <div class="text-xs opacity-75 mb-2" style="${textColor}">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
                    <div class="whitespace-pre-wrap text-sm leading-relaxed" id="${messageId}-content" style="${textColor}">‚ñã</div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }
        
        function updateStreamingMessage(messageId, content) {
            const contentElement = document.getElementById(messageId + '-content');
            if (contentElement) {
                contentElement.textContent = content + '‚ñã';
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        function finalizeStreamingMessage(messageId, content) {
            const messageElement = document.getElementById(messageId);
            const contentElement = document.getElementById(messageId + '-content');
            
            if (contentElement && messageElement) {
                // Replace the plain text content with rendered markdown
                const markdownHtml = renderMarkdown(content);
                
                // Get the parent bubble container
                const bubbleContainer = contentElement.parentElement;
                const roleHeader = bubbleContainer.querySelector('.text-xs');
                
                // Replace the content while preserving the role header
                bubbleContainer.innerHTML = roleHeader.outerHTML + markdownHtml;
                
                // Apply syntax highlighting
                bubbleContainer.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }
        
        function removeMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
        }

        function updateStatus(elementId, message, className) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `text-sm ${className}`;
            
            // Clear status after 3 seconds
            setTimeout(() => {
                element.textContent = '';
                element.className = 'text-sm';
            }, 3000);
        }
        
        // HTML escape function (must be defined early)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Clear chat function
        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            
            // Clear all messages
            chatMessages.innerHTML = '<div class="text-center" style="color: var(--text-muted);">Start a conversation...</div>';
            
            // Clear conversation context
            conversationContext = [];
            
            // Show confirmation message briefly
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'chat-message mb-4 text-center';
            confirmationDiv.innerHTML = `
                <div class="inline-block px-4 py-2 rounded-lg" style="background-color: var(--accent-green); color: white;">
                    <div class="text-xs">‚úì Chat cleared</div>
                </div>
            `;
            
            chatMessages.appendChild(confirmationDiv);
            
            // Remove confirmation after 2 seconds
            setTimeout(() => {
                if (confirmationDiv.parentNode) {
                    confirmationDiv.remove();
                }
            }, 2000);
        }
        
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = html.getAttribute('data-theme');
            
            if (currentTheme === 'light') {
                html.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                localStorage.setItem('theme', 'dark');
                // Switch to dark syntax highlighting
                document.getElementById('hljs-dark').disabled = false;
                document.getElementById('hljs-light').disabled = true;
            } else {
                html.setAttribute('data-theme', 'light');
                themeIcon.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'light');
                // Switch to light syntax highlighting
                document.getElementById('hljs-dark').disabled = true;
                document.getElementById('hljs-light').disabled = false;
            }
        }
        
        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'light') {
                html.setAttribute('data-theme', 'light');
                themeIcon.textContent = '‚òÄÔ∏è';
                // Enable light syntax highlighting
                document.getElementById('hljs-dark').disabled = true;
                document.getElementById('hljs-light').disabled = false;
            } else {
                html.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                // Enable dark syntax highlighting
                document.getElementById('hljs-dark').disabled = false;
                document.getElementById('hljs-light').disabled = true;
            }
        }
        
        // Markdown rendering with copy buttons
        function renderMarkdown(content) {
            const html = marked.parse(content);
            
            // Wrap code blocks with copy buttons
            const wrappedHtml = html.replace(
                /<pre><code([^>]*)>([\s\S]*?)<\/code><\/pre>/g,
                (match, attrs, code) => {
                    const id = 'code-' + Math.random().toString(36).substr(2, 9);
                    return `
                        <div class="code-block-wrapper">
                            <button class="copy-button" onclick="copyCode('${id}')" title="Copy code">
                                Copy
                            </button>
                            <pre><code${attrs} id="${id}">${code}</code></pre>
                        </div>
                    `;
                }
            );
            
            return `<div class="markdown-content text-sm leading-relaxed">${wrappedHtml}</div>`;
        }
        
        // Copy code function
        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            if (codeElement) {
                const text = codeElement.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    // Visual feedback
                    const button = codeElement.parentElement.querySelector('.copy-button');
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            }
        }
        
        // Display enhanced AI summary with sources only (no raw results)
        function displaySearchResults(results, llmSummary = null, processingStatus = null) {
            console.log('displaySearchResults called with:', results.length, 'results'); // Debug
            const chatMessages = document.getElementById('chatMessages');
            
            // Clear initial message
            if (chatMessages.children.length === 1 && chatMessages.children[0].querySelector('[style*="color: var(--text-muted)"]')) {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message mb-4 text-left';
            
            let renderedContent = '';
            
            // Display enhanced AI summary with sources
            if (llmSummary && processingStatus === 'success') {
                // Process the AI summary for better rendering (including markdown-like formatting)
                const processedSummary = renderMarkdown(llmSummary);
                
                renderedContent = `<div class="p-4 rounded-lg" style="background-color: var(--bg-tertiary); border-left: 4px solid var(--accent-blue);">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--accent-blue);">üîç Search Analysis</h3>
                    <div class="text-sm leading-relaxed" style="color: var(--text-primary);">
                        ${processedSummary}
                    </div>
                </div>`;
            } else {
                // Fallback when AI processing fails - show condensed results with sources
                renderedContent = `<div class="p-4 rounded-lg" style="background-color: var(--bg-tertiary); border-left: 4px solid var(--accent-yellow);">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--accent-yellow);">‚ö†Ô∏è Search Results</h3>
                    <div class="text-sm mb-3" style="color: var(--text-muted);">AI processing unavailable (${processingStatus || 'unknown error'}). Showing condensed results:</div>`;
                
                // Show condensed results when AI processing fails
                for (let i = 0; i < Math.min(results.length, 3); i++) {
                    const result = results[i];
                    const snippet = result.snippet || result.content || 'No description available';
                    const truncatedSnippet = snippet.length > 200 ? snippet.substring(0, 200) + '...' : snippet;
                    
                    renderedContent += `<div class="mb-3 pb-2" style="border-bottom: 1px solid var(--border-color);">
                        <div class="font-medium mb-1" style="color: var(--text-primary);">${escapeHtml(result.title)}</div>
                        <div class="text-xs mb-1" style="color: var(--text-muted);">${escapeHtml(truncatedSnippet)}</div>
                    </div>`;
                }
                
                // Add sources section for fallback
                renderedContent += `<div class="mt-4 pt-3" style="border-top: 1px solid var(--border-color);">
                    <div class="font-semibold mb-2" style="color: var(--text-primary);">Sources:</div>`;
                
                results.forEach((result, index) => {
                    renderedContent += `<div class="text-xs mb-1">
                        <a href="${escapeHtml(result.url)}" target="_blank" class="hover:underline" style="color: var(--accent-blue);">
                            [${index + 1}] ${escapeHtml(result.title)}
                        </a>
                    </div>`;
                });
                
                renderedContent += `</div></div>`;
            }

            messageDiv.innerHTML = `
                <div class="inline-block max-w-full lg:max-w-4xl px-4 py-3 rounded-lg" style="background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color);">
                    <div class="text-xs opacity-75 mb-2" style="color: var(--text-primary);">Assistant</div>
                    ${renderedContent}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Create context summary for AI with more comprehensive content
        function createSearchContextSummary(results) {
            return results.map(result => {
                const snippet = result.snippet || result.content || 'No description available';
                // Increased context limit for AI to 250 characters per result
                const truncatedSnippet = snippet.length > 250 ? snippet.substring(0, 250) + '...' : snippet;
                return `${result.title}: ${truncatedSnippet}`;
            }).join(' | ');
        }
        
        // Load available models from GPUStack
        async function loadAvailableModels() {
            try {
                const response = await fetch(`${API_BASE}/api/models`);
                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.models || [];
                    updateModelSelector();
                } else {
                    console.error('Failed to load models');
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }
        
        // Update the model selector dropdown
        function updateModelSelector() {
            const selector = document.getElementById('modelSelector');
            
            if (availableModels.length === 0) {
                selector.innerHTML = '<option value="qwen3">Qwen3 (Default)</option>';
                return;
            }
            
            selector.innerHTML = '';
            
            availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.name;
                
                // Create a friendly display name
                let displayName = model.name;
                if (model.meta?.n_params) {
                    const params = (model.meta.n_params / 1e9).toFixed(1);
                    displayName += ` (${params}B)`;
                }
                
                // Add status indicator
                if (model.ready_replicas === 0) {
                    displayName += ' - Offline';
                    option.disabled = true;
                    option.style.color = '#6b7280';
                }
                
                option.textContent = displayName;
                
                // Select current model
                if (model.name === currentModel) {
                    option.selected = true;
                }
                
                selector.appendChild(option);
            });
            
            // Update model info panel
            updateModelInfo();
        }
        
        // Handle model change
        function changeModel() {
            const selector = document.getElementById('modelSelector');
            const newModel = selector.value;
            
            if (newModel !== currentModel) {
                currentModel = newModel;
                
                // Save to localStorage
                localStorage.setItem('selectedModel', currentModel);
                
                // Update model info panel
                updateModelInfo();
                
                // Add system message about model change
                addMessageToChat('system', `Switched to model: ${currentModel}`);
                
                console.log('Model changed to:', currentModel);
            }
        }
        
        // Update model info panel
        function updateModelInfo() {
            const currentModelData = availableModels.find(m => m.name === currentModel);
            
            if (!currentModelData) return;
            
            // Find the model info container by looking for the h3 with "Model Info" text
            const modelInfoHeaders = document.querySelectorAll('h3');
            let modelInfoContainer = null;
            
            for (const header of modelInfoHeaders) {
                if (header.textContent.includes('Model Info')) {
                    modelInfoContainer = header.parentElement;
                    break;
                }
            }
            
            if (!modelInfoContainer) return;
            
            const infoContainer = modelInfoContainer.querySelector('.space-y-2');
            if (!infoContainer) return;
            
            const contextTokens = currentModelData.meta?.n_ctx || 8192;
            const params = currentModelData.meta?.n_params ? 
                (currentModelData.meta.n_params / 1e9).toFixed(1) + 'B' : 'Unknown';
            
            // Calculate max tokens using the same logic as the dynamic function
            const dynamicMaxTokens = Math.floor(contextTokens * 0.6);
            const maxResponseTokens = Math.min(Math.max(dynamicMaxTokens, 1000), 50000);
            
            infoContainer.innerHTML = `
                <div class="flex justify-between">
                    <span>Model:</span>
                    <span style="color: var(--accent-blue);">${currentModel}</span>
                </div>
                <div class="flex justify-between">
                    <span>Parameters:</span>
                    <span style="color: var(--accent-blue);">${params}</span>
                </div>
                <div class="flex justify-between">
                    <span>Context:</span>
                    <span style="color: var(--accent-blue);">${contextTokens.toLocaleString()} tokens</span>
                </div>
                <div class="flex justify-between">
                    <span>Max Response:</span>
                    <span style="color: var(--accent-blue);">${maxResponseTokens.toLocaleString()} tokens (60%)</span>
                </div>
                <div class="flex justify-between">
                    <span>Status:</span>
                    <span style="color: ${currentModelData.ready_replicas > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                        ${currentModelData.ready_replicas > 0 ? 'Online' : 'Offline'}
                    </span>
                </div>
            `;
        }
        
        // Initialize saved model preference
        function initModelPreference() {
            const savedModel = localStorage.getItem('selectedModel');
            if (savedModel) {
                currentModel = savedModel;
            }
        }
        
        // Initialize theme when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initModelPreference();
        });
    </script>
</body>
</html>
